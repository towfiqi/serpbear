name: CI

on:
   push:
      branches: [main, master, develop]
   pull_request:
      branches: [main, master, develop]

concurrency:
   group: ci-${{ github.ref }}
   cancel-in-progress: true

jobs:
   lint:
      name: Lint
      runs-on: ubuntu-latest
      steps:
         - name: Checkout
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: '20'
              cache: 'npm'

         - name: Install dependencies
           run: npm ci

         - name: Run ESLint
           run: npm run lint

         - name: Run Stylelint
           run: npm run lint:css

         - name: Check Prettier formatting
           run: npx prettier --check .

   typecheck:
      name: Type Check
      runs-on: ubuntu-latest
      steps:
         - name: Checkout
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: '20'
              cache: 'npm'

         - name: Install dependencies
           run: npm ci

         - name: Run TypeScript
           run: npx tsc --noEmit

   test:
      name: Test
      runs-on: ubuntu-latest
      needs: [lint]
      strategy:
         matrix:
            node-version: ['18', '20', '22']
      steps:
         - name: Checkout
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: ${{ matrix.node-version }}
              cache: 'npm'

         - name: Install dependencies
           run: npm ci

         - name: Run tests
           run: npm run test:ci

         - name: Upload coverage
           if: matrix.node-version == '20'
           uses: codecov/codecov-action@v4
           with:
              fail_ci_if_error: false
           continue-on-error: true

   build:
      name: Build
      runs-on: ubuntu-latest
      needs: [lint, typecheck, test]
      steps:
         - name: Checkout
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: '20'
              cache: 'npm'

         - name: Install dependencies
           run: npm ci

         - name: Build
           run: npm run build

   docker:
      name: Docker Build
      runs-on: ubuntu-latest
      needs: [build]
      if: github.event_name == 'push'
      steps:
         - name: Checkout
           uses: actions/checkout@v4

         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         - name: Build Docker image
           uses: docker/build-push-action@v5
           with:
              context: .
              push: false
              cache-from: type=gha
              cache-to: type=gha,mode=max
